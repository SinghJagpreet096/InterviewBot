PYTHON_VERSION=3.10.12
VENV_NAME=.venv
PYTHON=$(VENV_NAME)/bin/python
PIP=$(VENV_NAME)/bin/pip
MODEL=llama3.2:1b
APP=app.py

.PHONY: help pyenv setup venv install install-ollama ollama pull run clean

help:
	@echo "Available commands:"
	@echo "  make setup          	- Setup Virtual Environment and install dependencies"
	@echo "  make setup-ollama   	- Install Ollama and pull model"
	@echo "  make run-app        	- Run Streamlit app"
	@echo "  make stop-app       	- Stop only Streamlit app"
	@echo "  make clean          	- Remove virtual environment and stop all services"


setup:
	@echo "ğŸ“¦ Installing pyenv (if missing)..."
	@which pyenv >/dev/null 2>&1 || (curl https://pyenv.run | bash && exec $$SHELL)
	@echo "ğŸ“¦ Installing pyenv-virtualenv (if missing)..."
	@pyenv virtualenvs >/dev/null 2>&1 || brew install pyenv-virtualenv || true
	@echo "ğŸ“¦ Installing Python $(PYTHON_VERSION) via pyenv..."
	pyenv install -s $(PYTHON_VERSION)
	@echo "ğŸ”§ Creating virtual environment $(VENV_NAME)..."
	pyenv virtualenv $(PYTHON_VERSION) $(VENV_NAME)
	pyenv local $(VENV_NAME)
	@echo "âœ… Done. Run: pyenv activate $(VENV_NAME)"

install:
	@echo "ğŸ“¦ Installing dependencies into venv..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt

setup-ollama:
	@echo "ğŸ§  Checking for Ollama..."
	@which ollama >/dev/null 2>&1 || ( \
		echo "ğŸ“¥ Ollama not found. Installing..." && \
		( \
			[ "$$(uname)" = "Darwin" ] && curl -fsSL https://ollama.com/install.sh | sh || \
			[ "$$(uname)" = "Linux" ] && curl -fsSL https://ollama.com/install.sh | sh \
		) \
	)
	@echo "ğŸ§  Starting Ollama in background..."
	pkill -f "ollama serve" || true
	nohup ollama serve > ollama.log 2>&1 &
	@echo "â¬‡ï¸ Pulling model: $(MODEL)"
	ollama pull $(MODEL)

run-app:
	@echo "ğŸš€ Launching InterviewBot..."
	streamlit run $(APP)

stop-app:
	@echo "ğŸ›‘ Stopping Streamlit app..."
	pkill -f "streamlit run" || true
	@echo "ğŸ›‘ Stopping Ollama service..."
	pkill -f "ollama serve" || true
clean:
	@echo "ğŸ§¹ Cleaning up..."
	@echo "ğŸ›‘ Stopping Ollama service..."
	-pkill -f "ollama serve" || true
	@echo "ğŸ›‘ Stopping Streamlit app..."
	-pkill -f "streamlit run" || true
	@echo "ğŸ§¹ Removing pyenv virtualenv $(VENV_NAME)..."
	pyenv uninstall -f $(VENV_NAME)
	@echo "ğŸ§¹ Cleaned up all project state."

